{
  "version": 3,
  "sources": ["../../@nprapps/sidechain/src/encoding.js", "../../@nprapps/sidechain/src/guest.js", "../../@nprapps/sidechain/src/index.js"],
  "sourcesContent": ["export var decodeLegacy = function(message) {\n  var matcher = /pymxPYMx(.*?)xPYMx(.*?)xPYMx(.*)/;\n  var matched = message.match(matcher);\n  if (!matched) return {};\n  var [ _, id, type, value ] = matched;\n  return { type, value, sentinel: \"pym\" };\n};\n\nexport var decode = function(message) {\n  if (message.match(/^pym/)) {\n    return decodeLegacy(message);\n  }\n  return JSON.stringify(message);\n}\n\nexport var encodeLegacy = function(id, param, value) {\n  return [\"pym\", id, param, value].join(\"xPYMx\");\n}\n", "import { encodeLegacy, decode } from \"./encoding.js\";\n\nexport default class SidechainGuest {\n  constructor(options = {}) {\n    var here = new URL(window.location);\n    this.id = options.id || here.searchParams.get(\"childId\");\n    this.options = options;\n\n    this.lastHeight = 0;\n    this.listeners = {};\n\n    this.sendHeight = this.sendHeight.bind(this);\n    this.onMessage = this.onMessage.bind(this);\n\n    window.addEventListener(\"resize\", this.sendHeight);\n    window.addEventListener(\"message\", this.onMessage);\n\n    if (!options.disablePolling) {\n      this.interval = setInterval(() => this.sendHeight(), options.polling || 300);\n    }\n\n    this.sendHeight();\n  }\n\n  unregister() {\n    window.removeEventListener(\"resize\", this.sendHeight);\n    window.removeEventListener(\"message\", this.onMessage);\n    if (this.interval) {\n      clearInterval(this.interval);\n    }\n  }\n\n  sendMessage(message) {\n    if (typeof message == \"object\" && !(message instanceof Array)) {\n      if (this.options.sentinel && !message.sentinel) {\n        message.sentinel = this.options.sentinel;\n      }\n    }\n    window.parent.postMessage(message, \"*\");\n  }\n\n  sendLegacy(param, value) {\n    var pymFormatted = encodeLegacy(this.id, param, value);\n    window.parent.postMessage(pymFormatted, \"*\");\n  }\n\n  on(event, callback) {\n    if (!this.listeners[event]) this.listeners[event] = [];\n    this.listeners[event].push(callback);\n  }\n\n  off(event, callback) {\n    if (!callback) {\n      delete this.listeners[event];\n    } else {\n      this.listeners[event] = this.listeners[event].filter(c => c != callback);\n    }\n  }\n\n  onMessage(e) {\n    var decoded = typeof e.data == \"string\" ? decode(e.data) : e.data;\n    if (decoded.sentinel == \"pym\" && decoded.type in this.listeners) {\n      this.listeners[decoded.type].forEach(cb => cb(decoded.value));\n    }\n  }\n\n  sendHeight() {\n    var height = document.documentElement.offsetHeight;\n    if (this.lastHeight == height) return;\n    this.lastHeight = height;\n    var pymFormatted = encodeLegacy(this.id, \"height\", height);\n    // for convenience, we just use the same format as AMP\n    var ampFormatted = {\n      sentinel: \"amp\",\n      type: \"embed-size\",\n      height\n    };\n    this.sendMessage(pymFormatted);\n    this.sendMessage(ampFormatted);\n  }\n}\n", "import { encodeLegacy, decode } from \"./encoding.js\";\nimport SidechainGuest from \"./guest.js\";\n\nvar template = `\n<style>\n:host {\n  display: block;\n}\n\n:host[hidden] {\n  display: none;\n}\n\niframe {\n  width: 100%;\n  border: none;\n}\n</style>\n<iframe seamless=\"true\" scrolling=\"no\"></iframe>`;\n\nexport class Sidechain extends HTMLElement {\n  constructor() {\n    super();\n\n    var root = this.attachShadow({ mode: \"open\" });\n    root.innerHTML = template;\n    this.iframe = root.querySelector(\"iframe\");\n\n    this.onMessage = this.onMessage.bind(this);\n  }\n\n  connectedCallback() {\n    // prevent duplicate listeners\n    window.removeEventListener(\"message\", this.onMessage);\n    window.addEventListener(\"message\", this.onMessage);\n  }\n\n  disconnectedCallback() {\n    window.removeEventListener(\"message\", this.onMessage);\n  }\n\n  static get observedAttributes() {\n    return [\"src\", \"id\"];\n  }\n\n  attributeChangedCallback(attribute, was, value) {\n    switch (attribute) {\n      case \"src\":\n        // support cross-origin permission setting\n        if (this.hasAttribute(\"allow\")) {\n          var permissions = this.getAttribute(\"allow\");\n          this.iframe.setAttribute(\"allow\", permissions);\n        }\n        this.iframe.src = value;\n        break;\n\n      case \"id\":\n        this.iframe.id = value;\n    }\n  }\n\n  onMessage(e) {\n    // ignore other iframes\n    if (e.source != this.iframe.contentWindow) return;\n    var decoded = typeof e.data == \"string\" ? decode(e.data) : e.data;\n    if (decoded.type == \"embed-size\" || decoded.type == \"height\") {\n      this.iframe.height = decoded.value || decoded.height;\n    }\n  }\n\n  sendMessage(message) {\n    if (typeof message == \"object\" && !(message instanceof Array) && this.hasAttribute(\"sentinel\")) {\n      message.sentinel = message.sentinel || this.getAttribute(\"sentinel\");\n    }\n    this.iframe.contentWindow.postMessage(message, \"*\");\n  }\n\n  sendLegacy(param, value) {\n    var pymFormatted = encodeLegacy(this.id, param, value);\n    this.sendMessage(pymFormatted);\n  }\n\n  static registerGuest(options) {\n    return new SidechainGuest(options);\n  }\n\n  static matchMessage(pattern, callback) {\n    return function(e) {\n      var { data } = e;\n      for (var k in pattern) {\n        if (data[k] !== pattern[k]) return;\n      }\n      callback(e.data, e);\n    }\n  }\n\n  get src() {\n    return this.getAttribute(\"src\");\n  }\n\n  set src(value) {\n    return this.setAttribute(\"src\", value);\n  }\n\n  get sentinel() {\n    return this.getAttribute(\"sentinel\");\n  }\n\n  set sentinel(value) {\n    return this.setAttribute(\"sentinel\", value);\n  }\n\n}\n\nSidechain.Guest = SidechainGuest;\n\ntry {\n  window.customElements.define(\"side-chain\", Sidechain);\n} catch (err) {\n  console.log(\"Sidechain couldn't be (re)defined\");\n}\n\nexport default Sidechain;\n"],
  "mappings": "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",
  "names": []
}
